<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bitel | Postes (ZIP CSV) vs Línea KMZ/KML</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://unpkg.com/@tmcw/togeojson@5.8.1/dist/togeojson.umd.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root{ --accent:#10b981; }
  body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif; background:#f3f4f6; color:#111827; margin:0; }
  header{ display:flex; align-items:center; gap:12px; padding:20px; justify-content:center;}
  header img{ height:56px; }
  h1{ font-size:22px; margin:0; font-weight:700; }
  .bar{display:flex; gap:12px; justify-content:center; padding:16px; flex-wrap:wrap;}
  .btn{ background:#2d2d2d; color:white; border:none; padding:12px 16px; border-radius:10px; cursor:pointer; font-weight:600; }
  .btn.secondary{ background:#6b7280; }
  .btn.accent{ background:var(--accent); }
  .card{background:white; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.08); width:min(1100px,92vw); margin:0 auto 18px; padding:16px;}
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
  input[type="number"], input[type="file"]{ padding:10px 12px; border:1px solid #d1d5db; border-radius:8px; }
  #map{ height:520px; border-radius:12px; }
  textarea{ width:100%; min-height:160px; border:1px solid #d1d5db; border-radius:10px; padding:12px; }
  .pill{ background:#e5e7eb; padding:6px 10px; border-radius:999px; font-size:12px; }
  .muted{ color:#6b7280; }
  .status{ font-size:12px; color:#374151; }
  .ok{ color:#059669; } .bad{ color:#dc2626; }
</style>
</head>
<body>
<header>
  <img alt="bitel" src="https://upload.wikimedia.org/wikipedia/commons/4/48/Bitel_logo.svg" onerror="this.style.display='none'">
  <h1>Filtro de Postes (CSV en ZIP) vs Línea (KMZ/KML)</h1>
</header>

<div class="bar">
  <input id="fileLine" type="file" accept=".kmz,.kml" hidden />
  <button class="btn accent" id="btnPickLine">Seleccionar Línea KMZ/KML</button>
  <span class="pill">Base: <b id="baseName">postes.csv.zip</b></span>
  <label class="pill">Radio (m): <input id="radius" type="number" value="20" min="1"></label>
  <button class="btn" id="btnExtract">Extraer</button>
  <button class="btn" id="btnCopy">Copiar</button>
  <button class="btn" id="btnDownloadTXT">Descargar TXT</button>
  <button class="btn" id="btnDownloadKMZ">Descargar KMZ</button>
  <button class="btn secondary" id="btnShowMap">Ver en mapa</button>
</div>

<div class="card">
  <div class="row muted" style="margin-bottom:8px;">
    <span>La app intentará cargar automáticamente <b>postes.csv.zip</b> (misma carpeta). También puedes cargar CSV(s) manualmente:</span>
    <input id="filePosts" type="file" accept=".csv" multiple>
  </div>
  <div class="status">
    <div id="statusPosts">Postes cargados: <b>0</b></div>
    <div id="statusLine">Línea: <b class="bad">no cargada</b></div>
    <div id="statusResult">Filtrados: <b>0</b></div>
  </div>
  <div id="map" style="display:none; margin-top:10px;"></div>
</div>

<div class="card">
  <textarea id="output" placeholder="Nombre;Lat;Lon;Distancia_m"></textarea>
</div>

<script>
(function(){
  const ZIP_NAME = "postes.csv.zip";
  let postes = [];     // [{name, lat, lon}]
  let filtered = [];   // [{name, lat, lon, dist}]
  let line = null;     // GeoJSON LineString
  let map, layerLine, layerPostesFiltered;

  // ---------- Estado UI ----------
  const elBase = document.getElementById("baseName");
  const stPosts = document.getElementById("statusPosts");
  const stLine  = document.getElementById("statusLine");
  const stRes   = document.getElementById("statusResult");
  function setPostsCount(n){ stPosts.innerHTML = "Postes cargados: <b>"+n+"</b>"; }
  function setLineLoaded(ok){
    stLine.innerHTML = "Línea: <b class='"+(ok?"ok":"bad")+"'>"+(ok?"cargada":"no cargada")+"</b>";
  }
  function setResultCount(n){ stRes.innerHTML = "Filtrados: <b>"+n+"</b>"; }

  // ---------- Utilidades ----------
  async function fetchBlob(url){
    const r = await fetch(url + "?v=" + Date.now(), {cache:"no-store"});
    if(!r.ok) throw new Error("No se pudo cargar " + url);
    return await r.blob();
  }
  async function fetchText(url){
    const r = await fetch(url + "?v=" + Date.now(), {cache:"no-store"});
    if(!r.ok) throw new Error("No se pudo cargar " + url);
    return await r.text();
  }

  function parseCSVWithPapa(text){
    const out = [];
    Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      worker: false,
      step: (row)=>{
        const r = row.data;
        const name = (r.Nombre ?? r.name ?? r.NAME ?? "Sin nombre").toString();
        const lat  = parseFloat(r.Latitud ?? r.lat ?? r.LAT);
        const lon  = parseFloat(r.Longitud ?? r.lon ?? r.LON);
        if(!isNaN(lat) && !isNaN(lon)) out.push({name, lat, lon});
      }
    });
    return out;
  }

  async function loadCSVFromZip(zipName = ZIP_NAME){
    const blob = await fetchBlob(zipName);
    const zip = await JSZip.loadAsync(blob);
    const entry = Object.keys(zip.files).find(n => n.toLowerCase().endsWith(".csv"));
    if(!entry) throw new Error("El ZIP no contiene un CSV");
    const csvText = await zip.files[entry].async("text");
    return parseCSVWithPapa(csvText);
  }

  async function readKMZtoKMLText(file){
    const zip = await JSZip.loadAsync(file);
    const kmlEntry = Object.keys(zip.files).find(n => n.toLowerCase().endsWith(".kml"));
    if(!kmlEntry) throw new Error("El KMZ no contiene un KML");
    return await zip.files[kmlEntry].async("text");
  }

  function parseKmlTextToGeoJSON(kmlText){
    const parser = new DOMParser();
    const doc = parser.parseFromString(kmlText, "text/xml");
    return toGeoJSON.kml(doc);
  }

  function lineStringFromGeojson(gj){
    for(const f of gj.features||[]){
      if(f.geometry && f.geometry.type==="LineString") return f;
    }
    return null;
  }

  function computeFiltered(radiusM){
    const ls = line.geometry;
    return postes.map(p=>{
      const dist = turf.pointToLineDistance(turf.point([p.lon, p.lat]), ls, {units:"meters"});
      return {...p, dist};
    }).filter(p=>p.dist<=radiusM).sort((a,b)=>a.dist-b.dist);
  }

  function resultToText(rows){
    return rows.map(r => `${r.name};${r.lat.toFixed(6)};${r.lon.toFixed(6)};${r.dist.toFixed(2)}`).join("\n");
  }

  function escapeXml(s){ return s.replace(/[<>&'"]/g,c=>({"<":"&lt;",">":"&gt;","&":"&amp;","'":"&apos;",'"':"&quot;"}[c])); }

  function buildKML(rows){
    const header = `<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2"><Document>`;
    const footer = `</Document></kml>`;
    const style = `<Style id="line"><LineStyle><color>ff00aaff</color><width>3</width></LineStyle></Style>
                   <Style id="pt"><IconStyle><color>ff10b981</color><scale>1.1</scale>
                   <Icon><href>http://maps.google.com/mapfiles/kml/paddle/grn-blank.png</href></Icon></IconStyle></Style>`;
    let linePlm = "";
    if(line){
      const coords = line.geometry.coordinates.map(([lon,lat])=>`${lon},${lat},0`).join(" ");
      linePlm = `<Placemark><name>Línea cargada</name><styleUrl>#line</styleUrl><LineString><coordinates>${coords}</coordinates></LineString></Placemark>`;
    }
    const ptsPlm = rows.map(r=>`<Placemark><name>${escapeXml(r.name)}</name><styleUrl>#pt</styleUrl><Point><coordinates>${r.lon},${r.lat},0</coordinates></Point></Placemark>`).join("");
    return header + style + linePlm + ptsPlm + footer;
  }

  // ---------- Eventos UI ----------
  document.getElementById("btnPickLine").onclick = ()=> document.getElementById("fileLine").click();

  document.getElementById("fileLine").addEventListener("change", async (ev)=>{
    const file = ev.target.files[0]; if(!file) return;
    let kmlText;
    if(file.name.toLowerCase().endsWith(".kmz")) kmlText = await readKMZtoKMLText(file);
    else kmlText = await file.text();
    const gj = parseKmlTextToGeoJSON(kmlText);
    line = lineStringFromGeojson(gj);
    setLineLoaded(!!line);
    if(!line){ alert("No se encontró una LineString en el archivo."); return; }
    alert("Línea cargada correctamente.");
  });

  // Carga manual de CSV(s) (fallback)
  document.getElementById("filePosts").addEventListener("change", async (ev)=>{
    postes = [];
    for(const file of ev.target.files){
      const txt = await file.text();
      postes.push(...parseCSVWithPapa(txt));
    }
    setPostsCount(postes.length);
    elBase.textContent = `Cargados manualmente (${postes.length} pts)`;
    alert("Base de postes cargada: "+postes.length+" puntos.");
  });

  document.getElementById("btnExtract").onclick = ()=>{
    if(!line){ alert("Carga primero la LÍNEA (KMZ/KML)."); return; }
    if(!postes.length){ alert("No hay postes cargados (revisa postes.csv.zip o carga manual)."); return; }
    const radius = Number(document.getElementById("radius").value)||20;
    filtered = computeFiltered(radius);
    document.getElementById("output").value = resultToText(filtered);
    setResultCount(filtered.length);
    alert(`Encontrados ${filtered.length} postes dentro de ${radius} m.`);
  };

  document.getElementById("btnCopy").onclick = async ()=>{
    const txt = document.getElementById("output").value || "";
    if(!txt){ alert("No hay contenido para copiar"); return; }
    await navigator.clipboard.writeText(txt);
    alert("Resultado copiado al portapapeles.");
  };

  document.getElementById("btnDownloadTXT").onclick = ()=>{
    const txt = document.getElementById("output").value || "";
    const blob = new Blob([txt], {type:"text/plain;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "postes_filtrados.txt";
    a.click();
    URL.revokeObjectURL(a.href);
  };

  document.getElementById("btnDownloadKMZ").onclick = async ()=>{
    if(!filtered.length){ alert("Primero ejecuta 'Extraer'"); return; }
    const kml = buildKML(filtered);
    const zip = new JSZip();
    zip.file("postes_filtrados.kml", kml);
    const blob = await zip.generateAsync({type:"blob"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "postes_filtrados.kmz";
    a.click();
    URL.revokeObjectURL(a.href);
  };

  document.getElementById("btnShowMap").onclick = ()=>{
    const mapDiv = document.getElementById("map");
    mapDiv.style.display = "block";
    if(!map){
      map = L.map("map");
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{ maxZoom:19, attribution:"© OpenStreetMap" }).addTo(map);
      layerLine = L.geoJSON(null, {style:{color:"#0ea5e9", weight:3}}).addTo(map);
      layerPostesFiltered = L.layerGroup().addTo(map);
      map.setView([-9.4, -77.57], 12);
    }
    layerLine.clearLayers();
    layerPostesFiltered.clearLayers();

    if(line){
      layerLine.addData(line);
      map.fitBounds(layerLine.getBounds(), {padding:[20,20]});
    }
    if(filtered.length){
      filtered.forEach(p=>{
        L.circleMarker([p.lat, p.lon], {radius:5})
          .bindPopup(`<b>${p.name}</b><br>${p.lat.toFixed(6)}, ${p.lon.toFixed(6)}<br>${p.dist.toFixed(2)} m`)
          .addTo(layerPostesFiltered);
      });
      const group = L.featureGroup([layerLine, layerPostesFiltered]);
      map.fitBounds(group.getBounds(), {padding:[20,20]});
    }
  };

  // ---------- Carga automática del ZIP ----------
  window.addEventListener("load", async ()=>{
    try{
      postes = await loadCSVFromZip(ZIP_NAME);
      setPostsCount(postes.length);
      elBase.textContent = `${ZIP_NAME} (${postes.length} pts)`;
    }catch(e){
      console.warn("No se pudo cargar postes.csv.zip automáticamente:", e);
      elBase.textContent = `${ZIP_NAME} (no cargado)`;
    }
    setLineLoaded(false);
  });

})();
</script>
</body>
</html>
